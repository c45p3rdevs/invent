<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario de Impresoras</title>

  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- QRCode (opcional para etiquetas) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.5/build/qrcode.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: { colors: { indigoKer: '#2a337e' } }
      },
      daisyui: { themes: ["light","corporate","emerald","dim","dracula","lofi"] }
    }
  </script>

  <style>
    /* Tabla → tarjetas en móvil */
    @media (max-width: 768px){
      table thead { display:none; }
      table tbody, table tr, table td { display:block; width:100%; }
      table tr { margin-bottom:.75rem; border:1px solid rgba(2,6,23,.08); border-radius:1rem; background:#fff; }
      table td { border-bottom:1px dashed rgba(2,6,23,.06); padding:.75rem 1rem; }
      table td:last-child { border-bottom:0; }
      table td::before{
        content: attr(data-label);
        display:block; font-size:.75rem; text-transform:uppercase; opacity:.6; margin-bottom:.25rem;
      }
    }

    /* Área de impresión de etiquetas */
    @media print {
      body { background: #fff !important; }
      #app { display:none !important; }
      #printArea { display:block !important; }
    }
    /* Etiquetas A4 (grid 3 x auto) – ajusta medidas si usas papel de etiqueta específico */
    #printArea { display:none; padding: 10mm; }
    .labels-grid {
      display:grid; gap:6mm;
      grid-template-columns: repeat(3, 1fr);
    }
    .label {
      border:1px dashed #cbd5e1; border-radius:8px; padding:6mm;
      display:flex; gap:6mm; align-items:center; min-height:38mm;
    }
    .label .logo { width:22mm; height:auto; object-fit:contain; }
    .label .qr   { width:26mm; height:26mm; }
    .label .meta { font-size:11px; line-height:1.2; }
    .label .meta .title{ font-weight:700; font-size:12px; }
    .label .meta .muted{ opacity:.7; }
  </style>
</head>

<body class="bg-base-200 min-h-dvh">
  <!-- ====== APP (pantalla) ====== -->
  <div id="app">
    <!-- Navbar institucional -->
    <header class="navbar bg-base-100 shadow-sm sticky top-0 z-30">
      <div class="flex-1 items-center gap-3">
        <img src="img/logob.png" alt="Logos institucionales" class="h-10 sm:h-12 object-contain" />
        <div class="flex flex-col leading-tight">
          <span class="font-bold text-lg sm:text-xl">Inventario · Impresoras</span>
          <span class="text-xs opacity-60">IMPRESORA · MODELO · NÚMERO DE SERIE · TONER · COLOR · ÁREA</span>
        </div>
      </div>
      <div class="flex-none">
        <label class="swap swap-rotate mr-2">
          <input type="checkbox" class="theme-controller" value="dracula" />
          <svg class="swap-off size-6" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M5 12a7 7 0 0 0 9.9 6.32A9 9 0 1 1 5 12z"/></svg>
          <svg class="swap-on size-6" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"/></svg>
        </label>
        <button id="btnExportCSV" class="btn btn-sm">Exportar CSV</button>
        <button id="btnExportXLSX" class="btn btn-sm ml-2">Exportar XLSX</button>
        <input id="fileImport" type="file" accept=".csv,.xlsx" class="hidden">
        <button id="btnImport" class="btn btn-sm ml-2">Importar</button>
        <button id="btnEtiquetas" class="btn btn-sm ml-2 btn-primary">Imprimir etiquetas</button>
      </div>
    </header>

    <main class="max-w-6xl mx-auto p-3 sm:p-4">
      <!-- Filtros -->
      <section class="w-full">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
          <label class="input input-bordered flex items-center gap-2 md:col-span-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="size-5 opacity-60" viewBox="0 0 24 24" fill="currentColor"><path d="M10 2a8 8 0 1 1-5.293 13.707l-2.853 2.853a1 1 0 0 1-1.414-1.414l2.853-2.853A8 8 0 0 1 10 2zm0 2a6 6 0 1 0 .001 12.001A6 6 0 0 0 10 4z"/></svg>
            <input id="q" type="text" placeholder="Buscar: impresora, modelo, serie, toner, área..." class="grow" />
          </label>
          <select id="fColor" class="select select-bordered">
            <option value="">Color: Todos</option>
            <option>Color</option>
            <option>Monocromática</option>
          </select>
          <select id="fArea" class="select select-bordered">
            <option value="">Área: Todas</option>
          </select>
        </div>
      </section>

      <!-- Tabla -->
      <section class="mt-3 w-full">
        <div class="overflow-x-auto shadow rounded-xl">
          <table class="table">
            <thead>
              <tr>
                <th>IMPRESORA</th>
                <th>MODELO</th>
                <th>NÚMERO DE SERIE</th>
                <th>TONER</th>
                <th>COLOR</th>
                <th>ÁREA</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbodyPrinters"></tbody>
          </table>
        </div>
        <p id="emptyState" class="text-center text-sm opacity-70 py-6 hidden">Sin registros. Agrega una impresora con “+”.</p>
      </section>
    </main>

    <!-- FAB -->
    <button class="btn btn-primary btn-circle fixed bottom-5 right-5 shadow-2xl" onclick="openNew()">
      <svg xmlns="http://www.w3.org/2000/svg" class="size-6" viewBox="0 0 24 24" fill="currentColor"><path d="M11 4a1 1 0 0 1 2 0v7h7a1 1 0 1 1 0 2h-7v7a1 1 0 1 1-2 0v-7H4a1 1 0 1 1 0-2h7V4z"/></svg>
    </button>

    <!-- Modal Alta/Edición -->
    <dialog id="modalForm" class="modal">
      <div class="modal-box max-w-2xl">
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
        </form>
        <h3 id="formTitle" class="font-bold text-lg">Nueva impresora</h3>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="form-control">
            <span class="label-text">IMPRESORA*</span>
            <input id="impresora" class="input input-bordered" placeholder="Alias / Nombre" required>
          </label>
          <label class="form-control">
            <span class="label-text">MODELO*</span>
            <input id="modelo" class="input input-bordered" placeholder="LaserJet Pro M404" required>
          </label>
          <label class="form-control">
            <span class="label-text">NÚMERO DE SERIE</span>
            <input id="serie" class="input input-bordered" placeholder="SN123456 / No. de serie">
          </label>
          <label class="form-control">
            <span class="label-text">TONER</span>
            <input id="toner" class="input input-bordered" placeholder="CF258A / TN-760 ...">
          </label>
          <label class="form-control">
            <span class="label-text">COLOR</span>
            <select id="color" class="select select-bordered">
              <option value="">Selecciona</option>
              <option>Color</option>
              <option>Monocromática</option>
            </select>
          </label>
          <label class="form-control md:col-span-2">
            <span class="label-text">ÁREA</span>
            <input id="area" class="input input-bordered" placeholder="Recepción / Sistemas / Dirección">
          </label>
        </div>
        <div class="modal-action">
          <button class="btn btn-ghost" onclick="modalForm.close()">Cancelar</button>
          <button id="btnSave" class="btn btn-primary" onclick="savePrinter()">Guardar</button>
        </div>
      </div>
    </dialog>

    <!-- Toasts -->
    <div id="toasts" class="toast toast-end z-50"></div>
  </div>

  <!-- ====== PRINT AREA (solo al imprimir) ====== -->
  <div id="printArea">
    <div class="labels-grid" id="labelsGrid"></div>
  </div>

  <script>
    // ====== Config ======
    const KEY = 'inv_impresoras_excel';
    let editingId = null;

    const $ = id => document.getElementById(id);
    const modalForm = $('modalForm');
    const tbody = $('tbodyPrinters');
    const emptyState = $('emptyState');

    const inputs = ['impresora','modelo','serie','toner','color','area'];

    // ====== Storage ======
    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){
        console.warn('Storage corrupta, reiniciando', e);
        return [];
      }
    }
    function save(list){ localStorage.setItem(KEY, JSON.stringify(list)); }

    let data = load();

    // ====== Render ======
    function render(){
      const q = ($('q').value || '').trim().toLowerCase();
      const fColor = $('fColor').value;
      const fArea = $('fArea').value;

      const filtered = data.filter(p=>{
        const text = [p.impresora,p.modelo,p.serie,p.toner,p.color,p.area].join(' ').toLowerCase();
        const passQ = !q || text.includes(q);
        const passC = !fColor || (p.color||'') === fColor;
        const passA = !fArea || (p.area||'') === fArea;
        return passQ && passC && passA;
      });

      // opciones de área dinámicas
      const areas = Array.from(new Set(data.map(x => (x.area||'').trim()).filter(Boolean))).sort();
      const selArea = $('fArea');
      const current = selArea.value;
      selArea.innerHTML = '<option value="">Área: Todas</option>' + areas.map(a=>`<option ${a===current?'selected':''}>${escapeHTML(a)}</option>`).join('');

      tbody.innerHTML = filtered.map(p=>rowHTML(p)).join('');
      emptyState.classList.toggle('hidden', filtered.length !== 0);

      // Guarda el último conjunto filtrado para etiquetas
      window.__filteredForLabels = filtered;
    }

    function rowHTML(p){
      return `
      <tr class="align-top">
        <td data-label="IMPRESORA">
          <div class="flex flex-col">
            <span class="font-semibold">${escapeHTML(p.impresora||'')}</span>
            <span class="text-xs opacity-60">${escapeHTML(p.area||'—')}</span>
          </div>
        </td>
        <td data-label="MODELO">${escapeHTML(p.modelo||'')}</td>
        <td data-label="NÚMERO DE SERIE">${escapeHTML(p.serie||'')}</td>
        <td data-label="TONER">${escapeHTML(p.toner||'')}</td>
        <td data-label="COLOR">${badgeColor(p.color)}</td>
        <td data-label="ÁREA">${escapeHTML(p.area||'')}</td>
        <td data-label="Acciones">
          <div class="flex gap-1 justify-end">
            <button class="btn btn-xs" onclick='edit("${p.id}")'>Editar</button>
            <button class="btn btn-xs btn-error" onclick='del("${p.id}")'>Borrar</button>
          </div>
        </td>
      </tr>`;
    }

    function badgeColor(color){
      const map = { 'Color': 'badge-success', 'Monocromática': 'badge-neutral' };
      const c = (color||'').trim();
      return `<span class="badge ${map[c]||'badge-ghost'}">${escapeHTML(c||'—')}</span>`;
    }

    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ====== CRUD ======
    function openNew(){
      editingId = null;
      $('formTitle').textContent = 'Nueva impresora';
      for(const id of inputs){ $(id).value = ''; }
      modalForm.showModal();
    }

    function edit(id){
      const item = data.find(x=>x.id===id);
      if(!item) return;
      editingId = id;
      $('formTitle').textContent = 'Editar impresora';
      for(const k of inputs){ $(k).value = item[k] ?? ''; }
      modalForm.showModal();
    }

    function del(id){
      const item = data.find(x=>x.id===id);
      if(!item) return;
      if(confirm(`¿Eliminar "${item.impresora}"?`)){
        data = data.filter(x=>x.id!==id);
        save(data); render();
        toast('Eliminado','error');
      }
    }

    function getFormData(){
      const obj = {};
      for(const k of inputs){
        const el = $(k);
        obj[k] = el.value.trim();
      }
      if(!obj.impresora || !obj.modelo){ toast('Completa IMPRESORA y MODELO','warning'); return null; }
      return obj;
    }

    function savePrinter(){
      const fd = getFormData();
      if(!fd) return;
      if(editingId){
        data = data.map(p => p.id===editingId ? ({...p, ...fd}) : p);
        toast('Actualizado','info');
      }else{
        data.unshift({ id: crypto.randomUUID(), ...fd });
        toast('Guardado','success');
      }
      save(data); render(); modalForm.close();
    }

    // ====== CSV / XLSX ======
    function toCSV(list){
      const headers = ['IMPRESORA','MODELO','NÚMERO DE SERIE','TONER','COLOR','ÁREA'];
      const keys    = ['impresora','modelo','serie','toner','color','area'];
      const lines = [headers.join(',')].concat(list.map(o => keys.map(k => csvEscape(o[k] ?? '')).join(',')));
      return lines.join('\n');
    }
    function csvEscape(v){ v = String(v); return /[",\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v; }
    function download(filename, blob){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    $('btnExportCSV').addEventListener('click', ()=>{
      const csv = toCSV(data);
      download('IMPRESORAS.csv', new Blob([csv], {type:'text/csv;charset=utf-8;'}));
      toast('CSV exportado','success');
    });

    $('btnExportXLSX').addEventListener('click', ()=>{
      const headers = ['IMPRESORA','MODELO','NÚMERO DE SERIE','TONER','COLOR','ÁREA'];
      const rows = data.map(o => ({
        'IMPRESORA': o.impresora ?? '',
        'MODELO': o.modelo ?? '',
        'NÚMERO DE SERIE': o.serie ?? '',
        'TONER': o.toner ?? '',
        'COLOR': o.color ?? '',
        'ÁREA': o.area ?? ''
      }));
      const ws = XLSX.utils.json_to_sheet(rows, { header: headers });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'IMPRESORAS');
      const out = XLSX.write(wb, { bookType:'xlsx', type:'array' });
      download('IMPRESORAS.xlsx', new Blob([out], {type: "application/octet-stream"}));
      toast('XLSX exportado','success');
    });

    $('btnImport').addEventListener('click', ()=> $('fileImport').click());
    $('fileImport').addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const name = file.name.toLowerCase();
      if(name.endsWith('.csv')){
        const text = await file.text();
        importRows(parseCSV(text));
      }else if(name.endsWith('.xlsx')){
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type:'array' });
        const sh = wb.SheetNames[0];
        const ws = wb.Sheets[sh];
        const rows = XLSX.utils.sheet_to_json(ws, { defval:'' });
        importRows(rows);
      }else{
        toast('Formato no soportado','error');
      }
      e.target.value = '';
    });

    function importRows(rows){
      const norm = rows.map(r => ({
        impresora: String(r['IMPRESORA'] ?? r['Impresora'] ?? r['impresora'] ?? '').trim(),
        modelo:    String(r['MODELO'] ?? r['Modelo'] ?? r['modelo'] ?? '').trim(),
        serie:     String(r['NÚMERO DE SERIE'] ?? r['NUMERO DE SERIE'] ?? r['SERIE'] ?? r['Serie'] ?? r['serie'] ?? '').trim(),
        toner:     String(r['TONER'] ?? r['Toner'] ?? r['toner'] ?? '').trim(),
        color:     String(r['COLOR'] ?? r['Color'] ?? r['color'] ?? '').trim(),
        area:      String(r['ÁREA'] ?? r['AREA'] ?? r['Area'] ?? r['area'] ?? '').trim(),
      })).filter(x => x.impresora || x.modelo || x.serie);

      let added = 0;
      for(const row of norm){
        let idx = -1;
        if(row.serie) idx = data.findIndex(x => (x.serie||'').toLowerCase()===row.serie.toLowerCase());
        if(idx < 0){
          idx = data.findIndex(x =>
            (x.impresora||'').toLowerCase()===row.impresora.toLowerCase() &&
            (x.modelo||'').toLowerCase()===row.modelo.toLowerCase()
          );
        }
        if(idx >= 0){
          for(const k of ['impresora','modelo','serie','toner','color','area']){
            if(!data[idx][k] && row[k]) data[idx][k] = row[k];
          }
        }else{
          data.push({ id: crypto.randomUUID(), ...row });
          added++;
        }
      }
      save(data); render();
      toast(`Importadas ${added} filas`, 'info');
    }

    // CSV básico
    function parseCSV(str){
      const lines = str.replace(/\r/g,'').split('\n').filter(Boolean);
      if(!lines.length) return [];
      const headers = splitCSVLine(lines[0]).map(h=>h.trim());
      const out = [];
      for(let i=1;i<lines.length;i++){
        const cells = splitCSVLine(lines[i]);
        const obj = {};
        headers.forEach((h,idx)=> obj[h] = cells[idx] ?? '');
        out.push(obj);
      }
      return out;
    }
    function splitCSVLine(line){
      const res = []; let cur = ''; let inQ = false;
      for(let i=0;i<line.length;i++){
        const c = line[i];
        if(c === '"' ){
          if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
          else inQ = !inQ;
        } else if(c === ',' && !inQ){ res.push(cur); cur=''; }
        else cur += c;
      }
      res.push(cur);
      return res;
    }

    // ====== Etiquetas (impresión) ======
    $('btnEtiquetas').addEventListener('click', ()=>{
      // Usa el conjunto actualmente filtrado (render lo actualiza)
      const list = window.__filteredForLabels || data;
      const grid = $('labelsGrid');
      grid.innerHTML = '';
      for(const item of list){
        const card = document.createElement('div');
        card.className = 'label';
        card.innerHTML = `
          <img src="img/logob.png" class="logo" alt="logo">
          <div class="meta">
            <div class="title">${escapeHTML(item.impresora || '—')}</div>
            <div class="muted">Modelo: ${escapeHTML(item.modelo || '—')}</div>
            <div>Núm. Serie: <b>${escapeHTML(item.serie || '—')}</b></div>
            <div class="muted">Área: ${escapeHTML(item.area || '—')}</div>
            <div class="muted">Tóner: ${escapeHTML(item.toner || '—')}</div>
          </div>
          <canvas class="qr"></canvas>
        `;
        grid.appendChild(card);

        // Genera QR con el número de serie (si existe), si no, con impresora+modelo
        const value = item.serie?.trim() ? item.serie.trim() : `${item.impresora||''} | ${item.modelo||''}`;
        const canvas = card.querySelector('canvas.qr');
        try { QRCode.toCanvas(canvas, value, { margin: 0, width: 140 }); } catch(e){}
      }
      // Lanza impresión (usa @media print)
      window.print();
    });

    // ====== Eventos UI ======
    $('q').addEventListener('input', render);
    $('fColor').addEventListener('change', render);
    $('fArea').addEventListener('change', render);

    // ====== Toast ======
    function toast(msg, type='success'){
      const el = document.createElement('div');
      const styles = { success:'alert-success', error:'alert-error', info:'alert-info', warning:'alert-warning' };
      el.className = `alert ${styles[type]||'alert-info'} shadow`;
      el.innerHTML = `<span>${escapeHTML(msg)}</span>`;
      document.getElementById('toasts').appendChild(el);
      setTimeout(()=> el.remove(), 2500);
    }

    // Init
    render();
  </script>
</body>
</html>
