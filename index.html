<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario de Impresoras</title>

  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- QRCode (para etiquetas) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.5/build/qrcode.min.js"></script>
  <!-- Partículas (tsparticles) -->
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@3/tsparticles.bundle.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: { colors: { indigoKer: '#2a337e' } }
      },
      daisyui: { themes: ["light","corporate","emerald","dim","dracula","lofi"] }
    }
  </script>

  <style>
    /* ===== Imprimir etiquetas ===== */
    @media print {
      body { background: #fff !important; }
      #app { display:none !important; }
      #printArea { display:block !important; }
    }
    #printArea { display:none; padding: 10mm; }
    .labels-grid { display:grid; gap:6mm; grid-template-columns: repeat(3, 1fr); }
    .label {
      border:1px dashed #cbd5e1; border-radius:8px; padding:6mm;
      display:flex; gap:6mm; align-items:center; min-height:38mm;
    }
    .label .logo { width:22mm; height:auto; object-fit:contain; }
    .label .qr   { width:26mm; height:26mm; }
    .label .meta { font-size:11px; line-height:1.2; }
    .label .meta .title{ font-weight:700; font-size:12px; }
    .label .meta .muted{ opacity:.7; }

    /* ===== Fondo partículas tenue ===== */
    #particles { position:fixed; inset:0; z-index:0; opacity:.15; pointer-events:none; }
    #app { position: relative; z-index: 1; }

    /* ===== Cards móviles ===== */
    .m-card{ background:oklch(var(--b1)); border:1px solid oklch(var(--b3)/.5); border-radius:1rem; padding:0.75rem; box-shadow:0 10px 24px rgba(2,6,23,.06)}
    .m-thumb{ width:3.5rem; height:3.5rem; border-radius:0.75rem; object-fit:cover; background:oklch(var(--b2)); border:1px solid oklch(var(--b3))}
    .m-title{ font-weight:700; line-height:1.1 }
    .m-sub{ font-size:.75rem; opacity:.7 }
    .m-row{ display:grid; grid-template-columns: 1fr 1fr; gap:.5rem; margin-top:.5rem }
    .m-k{ font-size:.65rem; text-transform:uppercase; opacity:.6 }
    .m-v{ font-size:.875rem }
  </style>
</head>

<body class="bg-base-200 min-h-dvh">
  <!-- Fondo partículas -->
  <div id="particles"></div>

  <!-- ====== APP ====== -->
  <div id="app">
    <!-- Navbar -->
    <header class="navbar bg-base-100 shadow-sm sticky top-0 z-30">
      <div class="flex-1 items-center gap-3">
        <img src="img/logob.png" alt="Logos" class="h-10 sm:h-12 object-contain" />
        <div class="flex flex-col leading-tight">
          <span class="font-bold text-lg sm:text-xl">Inventario · Impresoras</span>
          <span class="text-xs opacity-60">IMPRESORA · MARCA · MODELO · SERIE · TONER · COLOR · ÁREA · FOTO</span>
        </div>
      </div>
      <div class="flex-none items-center gap-2 pr-2">
        <!-- En móvil escondo algunos y dejo menú compacto -->
        <div class="hidden sm:flex items-center gap-2">
          <label class="swap swap-rotate mr-1">
            <input type="checkbox" class="theme-controller" value="dracula" />
            <svg class="swap-off size-6" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M5 12a7 7 0 0 0 9.9 6.32A9 9 0 1 1 5 12z"/></svg>
            <svg class="swap-on size-6" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"/></svg>
          </label>
          <button id="btnExportCSV"  class="btn btn-xs sm:btn-sm">CSV</button>
          <button id="btnExportXLSX" class="btn btn-xs sm:btn-sm">XLSX</button>
          <input id="fileImport" type="file" accept=".csv,.xlsx" class="hidden">
          <button id="btnImport" class="btn btn-xs sm:btn-sm">Importar</button>
          <button id="btnBackup"  class="btn btn-xs sm:btn-sm">Resp. JSON</button>
          <input id="fileRestore" type="file" accept=".json" class="hidden">
          <button id="btnRestore" class="btn btn-xs sm:btn-sm">Restaurar</button>
          <button id="btnEtiquetas" class="btn btn-xs sm:btn-sm btn-primary">Etiquetas</button>
        </div>

        <!-- Menú compacto móvil -->
        <div class="dropdown dropdown-end sm:hidden">
          <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
            <svg xmlns="http://www.w3.org/2000/svg" class="size-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zM12 13.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zM12 21a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/></svg>
          </div>
          <ul tabindex="0" class="menu menu-sm dropdown-content bg-base-100 rounded-box z-[1] mt-3 w-52 p-2 shadow">
            <li><a id="mCSV">Exportar CSV</a></li>
            <li><a id="mXLSX">Exportar XLSX</a></li>
            <li><a id="mImport">Importar</a></li>
            <li><a id="mBackup">Respaldar JSON</a></li>
            <li><a id="mRestore">Restaurar JSON</a></li>
            <li><a id="mEtiquetas" class="text-primary">Imprimir etiquetas</a></li>
            <li class="menu-title mt-1">Tema</li>
            <li>
              <label class="swap swap-rotate px-2">
                <input type="checkbox" class="theme-controller" value="dracula" />
                <span class="swap-off">Claro</span>
                <span class="swap-on">Oscuro</span>
              </label>
            </li>
          </ul>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto p-3 sm:p-4">
      <!-- Filtros -->
      <section class="w-full">
        <div class="grid grid-cols-1 sm:grid-cols-5 gap-2">
          <label class="input input-bordered flex items-center gap-2 sm:col-span-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="size-5 opacity-60" viewBox="0 0 24 24" fill="currentColor"><path d="M10 2a8 8 0 1 1-5.293 13.707l-2.853 2.853a1 1 0 0 1-1.414-1.414l2.853-2.853A8 8 0 0 1 10 2zm0 2a6 6 0 1 0 .001 12.001A6 6 0 0 0 10 4z"/></svg>
            <input id="q" type="text" placeholder="Buscar: impresora, marca, modelo, serie, tóner, área..." class="grow" />
          </label>
          <select id="fColor" class="select select-bordered">
            <option value="">Color: Todos</option>
            <option>Color</option>
            <option>Monocromática</option>
          </select>
          <select id="fArea" class="select select-bordered">
            <option value="">Área: Todas</option>
          </select>
        </div>
      </section>

      <!-- ====== Tabla (md+) ====== -->
      <section class="mt-3 w-full hidden md:block">
        <div class="overflow-x-auto shadow rounded-xl">
          <table class="table">
            <thead>
              <tr>
                <th></th>
                <th>IMPRESORA</th>
                <th>MARCA</th>
                <th>MODELO</th>
                <th>SERIE</th>
                <th>TONER</th>
                <th>COLOR</th>
                <th>ÁREA</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbodyPrinters"></tbody>
          </table>
        </div>
        <p id="emptyStateDesk" class="text-center text-sm opacity-70 py-6 hidden">Sin registros. Agrega una impresora con “+”.</p>
      </section>

      <!-- ====== Cards (móvil) ====== -->
      <section class="mt-3 grid gap-2 md:hidden" id="cardsList"></section>
      <p id="emptyStateMob" class="md:hidden text-center text-sm opacity-70 py-6 hidden">Sin registros. Agrega una impresora con “+”.</p>
    </main>

    <!-- FAB -->
    <button class="btn btn-primary btn-circle fixed bottom-5 right-5 shadow-2xl" onclick="openNew()">
      <svg xmlns="http://www.w3.org/2000/svg" class="size-6" viewBox="0 0 24 24" fill="currentColor"><path d="M11 4a1 1 0 0 1 2 0v7h7a1 1 0 1 1 0 2h-7v7a1 1 0 1 1-2 0v-7H4a1 1 0 1 1 0-2h7V4z"/></svg>
    </button>

    <!-- Modal Alta/Edición -->
    <dialog id="modalForm" class="modal">
      <div class="modal-box max-w-2xl">
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
        </form>
        <h3 id="formTitle" class="font-bold text-lg">Nueva impresora</h3>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="form-control">
            <span class="label-text">IMPRESORA*</span>
            <input id="impresora" class="input input-bordered" placeholder="Alias / Nombre" required>
          </label>
          <label class="form-control">
            <span class="label-text">MARCA</span>
            <input id="marca" class="input input-bordered" placeholder="HP / Brother / Epson ...">
          </label>
          <label class="form-control">
            <span class="label-text">MODELO*</span>
            <input id="modelo" class="input input-bordered" placeholder="LaserJet Pro M404" required>
          </label>
          <label class="form-control">
            <span class="label-text">NÚMERO DE SERIE</span>
            <input id="serie" class="input input-bordered" placeholder="SN123456 / No. de serie">
          </label>
          <label class="form-control">
            <span class="label-text">TÓNER</span>
            <input id="toner" class="input input-bordered" placeholder="CF258A / TN-760 ...">
          </label>
          <label class="form-control">
            <span class="label-text">COLOR</span>
            <select id="color" class="select select-bordered">
              <option value="">Selecciona</option>
              <option>Color</option>
              <option>Monocromática</option>
            </select>
          </label>
          <label class="form-control md:col-span-2">
            <span class="label-text">ÁREA</span>
            <input id="area" class="input input-bordered" placeholder="Recepción / Sistemas / Dirección">
          </label>

          <!-- FOTO -->
          <div class="md:col-span-2">
            <div role="tablist" class="tabs tabs-boxed">
              <button id="tabUpload" class="tab tab-active" type="button" onclick="showPhotoTab('upload')">Subir foto</button>
              <button id="tabCamera" class="tab" type="button" onclick="showPhotoTab('camera')">Tomar con cámara</button>
            </div>
            <!-- Subir -->
            <div id="paneUpload" class="mt-2">
              <input id="fotoFile" type="file" accept="image/*" class="file-input file-input-bordered w-full" />
              <p class="text-xs opacity-70 mt-1">Formatos: JPG/PNG. Se guarda comprimida en el navegador.</p>
            </div>
            <!-- Cámara -->
            <div id="paneCamera" class="mt-2 hidden">
              <div class="flex items-center gap-2">
                <video id="camPreview" class="rounded-box w-48 h-36 object-cover bg-black" autoplay playsinline></video>
                <canvas id="camCanvas" class="rounded-box w-48 h-36 hidden"></canvas>
              </div>
              <div class="mt-2 flex flex-wrap gap-2">
                <button id="btnStartCam" class="btn btn-sm" type="button" onclick="startCamera()">Iniciar cámara</button>
                <button id="btnShot" class="btn btn-sm btn-primary" type="button" onclick="takeShot()" disabled>Tomar foto</button>
                <button id="btnRetake" class="btn btn-sm hidden" type="button" onclick="retake()">Repetir</button>
                <button id="btnStopCam" class="btn btn-sm btn-ghost" type="button" onclick="stopCamera()">Detener</button>
              </div>
            </div>
            <!-- Preview -->
            <div class="mt-3">
              <span class="label-text">Vista previa</span>
              <div class="mt-1 flex items-center gap-3">
                <img id="fotoPreview" class="rounded-xl w-28 h-28 object-cover border border-base-300 bg-base-100" alt="preview" />
                <button class="btn btn-xs btn-ghost" type="button" onclick="clearPhoto()">Quitar foto</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-action">
          <button class="btn btn-ghost" onclick="modalForm.close()" type="button">Cancelar</button>
          <button id="btnSave" class="btn btn-primary" type="button" onclick="savePrinter()">Guardar</button>
        </div>
      </div>
    </dialog>

    <!-- Modal Ver -->
    <dialog id="modalView" class="modal">
      <div class="modal-box max-w-lg">
        <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
        <div class="flex items-start gap-4">
          <img id="v_foto" class="w-28 h-28 object-cover rounded-xl border border-base-300 bg-base-100" alt="foto">
          <div class="grow">
            <h3 id="v_impresora" class="font-bold text-lg"></h3>
            <p class="text-sm opacity-70">Marca: <span id="v_marca"></span></p>
            <p class="text-sm opacity-70">Modelo: <span id="v_modelo"></span></p>
            <p class="text-sm">Serie: <b id="v_serie"></b></p>
            <p class="text-sm opacity-70">Tóner: <span id="v_toner"></span></p>
            <p class="text-sm opacity-70">Área: <span id="v_area"></span></p>
            <p class="text-sm opacity-70">Color: <span id="v_color"></span></p>
          </div>
        </div>
      </div>
    </dialog>

    <!-- Toasts -->
    <div id="toasts" class="toast toast-end z-50"></div>
  </div>

  <!-- ====== PRINT AREA (solo al imprimir) ====== -->
  <div id="printArea">
    <div class="labels-grid" id="labelsGrid"></div>
  </div>

  <script>
    // ====== Config ======
    const KEY = 'inv_impresoras_excel';
    let editingId = null;
    let camStream = null;

    const $ = id => document.getElementById(id);
    const modalForm = $('modalForm');
    const modalView = $('modalView');
    const tbody = $('tbodyPrinters');
    const cardsList = $('cardsList');
    const emptyStateDesk = $('emptyStateDesk');
    const emptyStateMob  = $('emptyStateMob');

    const inputs = ['impresora','marca','modelo','serie','toner','color','area'];

    // ====== Storage ======
    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){
        console.warn('Storage corrupta, reiniciando', e);
        return [];
      }
    }
    function save(list){ localStorage.setItem(KEY, JSON.stringify(list)); }

    let data = load();

    // ====== Render ======
    function render(){
      const q = ($('q').value || '').trim().toLowerCase();
      const fColor = $('fColor').value;
      const fArea = $('fArea').value;

      const filtered = data.filter(p=>{
        const text = [p.impresora,p.marca,p.modelo,p.serie,p.toner,p.color,p.area].join(' ').toLowerCase();
        const passQ = !q || text.includes(q);
        const passC = !fColor || (p.color||'') === fColor;
        const passA = !fArea || (p.area||'') === fArea;
        return passQ && passC && passA;
      });

      // opciones de área dinámicas
      const areas = Array.from(new Set(data.map(x => (x.area||'').trim()).filter(Boolean))).sort();
      const selArea = $('fArea');
      const current = selArea.value;
      selArea.innerHTML = '<option value="">Área: Todas</option>' + areas.map(a=>`<option ${a===current?'selected':''}>${escapeHTML(a)}</option>`).join('');

      // Tabla (md+)
      tbody.innerHTML = filtered.map(p=>rowHTML(p)).join('');
      emptyStateDesk.classList.toggle('hidden', filtered.length !== 0);

      // Cards (móvil)
      cardsList.innerHTML = filtered.map(p=>cardHTML(p)).join('');
      emptyStateMob.classList.toggle('hidden', filtered.length !== 0);

      window.__filteredForLabels = filtered;
    }

    function rowHTML(p){
      const thumb = p.foto ? `<img src="${p.foto}" alt="foto" class="w-10 h-10 rounded-lg object-cover border border-base-300 bg-base-100" />` : `<div class="w-10 h-10 rounded-lg bg-base-300"></div>`;
      return `
      <tr class="align-top">
        <td class="py-2">${thumb}</td>
        <td>
          <div class="flex flex-col">
            <span class="font-semibold">${escapeHTML(p.impresora||'')}</span>
            <span class="text-xs opacity-60">${escapeHTML(p.area||'—')}</span>
          </div>
        </td>
        <td>${escapeHTML(p.marca||'')}</td>
        <td>${escapeHTML(p.modelo||'')}</td>
        <td>${escapeHTML(p.serie||'')}</td>
        <td>${escapeHTML(p.toner||'')}</td>
        <td>${badgeColor(p.color)}</td>
        <td>${escapeHTML(p.area||'')}</td>
        <td>
          <div class="flex flex-wrap gap-1 justify-end">
            <button class="btn btn-xs" onclick='view("${p.id}")'>Ver</button>
            <button class="btn btn-xs" onclick='edit("${p.id}")'>Editar</button>
            <button class="btn btn-xs btn-error" onclick='del("${p.id}")'>Borrar</button>
          </div>
        </td>
      </tr>`;
    }

    function cardHTML(p){
      const foto = p.foto
        ? `<img src="${p.foto}" alt="foto" class="m-thumb border" />`
        : `<div class="m-thumb border"></div>`;
      return `
      <article class="m-card">
        <div class="flex items-start gap-3">
          ${foto}
          <div class="min-w-0">
            <div class="m-title truncate">${escapeHTML(p.impresora||'Sin nombre')}</div>
            <div class="m-sub">${escapeHTML(p.marca||'—')} · ${escapeHTML(p.modelo||'—')}</div>
            <div class="mt-1">${badgeColor(p.color)}</div>
          </div>
          <div class="ml-auto">
            <div class="join join-vertical *:join-item">
              <button class="btn btn-xs" onclick='view("${p.id}")'>Ver</button>
              <button class="btn btn-xs" onclick='edit("${p.id}")'>Editar</button>
              <button class="btn btn-xs btn-error" onclick='del("${p.id}")'>Borrar</button>
            </div>
          </div>
        </div>
        <div class="m-row">
          <div>
            <div class="m-k">Serie</div>
            <div class="m-v">${escapeHTML(p.serie||'—')}</div>
          </div>
          <div>
            <div class="m-k">Tóner</div>
            <div class="m-v">${escapeHTML(p.toner||'—')}</div>
          </div>
          <div>
            <div class="m-k">Área</div>
            <div class="m-v">${escapeHTML(p.area||'—')}</div>
          </div>
        </div>
      </article>`;
    }

    // ====== Etiquetas (impresión) ======
    $('mEtiquetas')?.addEventListener('click', ()=> $('btnEtiquetas').click());
    document.getElementById('btnEtiquetas').addEventListener('click', ()=>{
      const list = window.__filteredForLabels || data;
      const grid = $('labelsGrid');
      grid.innerHTML = '';
      for(const item of list){
        const card = document.createElement('div');
        card.className = 'label';
        card.innerHTML = `
          <img src="img/logob.png" class="logo" alt="logo">
          <div class="meta">
            <div class="title">${escapeHTML(item.impresora || '—')}</div>
            <div class="muted">Marca: ${escapeHTML(item.marca || '—')}</div>
            <div class="muted">Modelo: ${escapeHTML(item.modelo || '—')}</div>
            <div>Núm. Serie: <b>${escapeHTML(item.serie || '—')}</b></div>
            <div class="muted">Área: ${escapeHTML(item.area || '—')}</div>
            <div class="muted">Tóner: ${escapeHTML(item.toner || '—')}</div>
          </div>
          <canvas class="qr"></canvas>
        `;
        grid.appendChild(card);
        const value = item.serie?.trim() ? item.serie.trim() : `${item.impresora||''} | ${item.marca||''} ${item.modelo||''}`;
        const canvas = card.querySelector('canvas.qr');
        try { QRCode.toCanvas(canvas, value, { margin: 0, width: 140 }); } catch(e){}
      }
      window.print();
    });

    // ====== Helpers UI ======
    function badgeColor(color){
      const map = { 'Color': 'badge-success', 'Monocromática': 'badge-neutral' };
      const c = (color||'').trim();
      return `<span class="badge ${map[c]||'badge-ghost'}">${escapeHTML(c||'—')}</span>`;
    }
    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ====== CRUD ======
    function openNew(){
      editingId = null;
      $('formTitle').textContent = 'Nueva impresora';
      for(const id of inputs){ $(id).value = ''; }
      clearPhoto();
      stopCamera();
      showPhotoTab('upload');
      modalForm.showModal();
    }

    function edit(id){
      const item = data.find(x=>x.id===id);
      if(!item) return;
      editingId = id;
      $('formTitle').textContent = 'Editar impresora';
      for(const k of inputs){ $(k).value = item[k] ?? ''; }
      setPreview(item.foto || '');
      stopCamera();
      showPhotoTab('upload');
      modalForm.showModal();
    }

    function view(id){
      const p = data.find(x=>x.id===id);
      if(!p) return;
      $('v_impresora').textContent = p.impresora || '—';
      $('v_marca').textContent     = p.marca || '—';
      $('v_modelo').textContent    = p.modelo || '—';
      $('v_serie').textContent     = p.serie || '—';
      $('v_toner').textContent     = p.toner || '—';
      $('v_area').textContent      = p.area  || '—';
      $('v_color').textContent     = p.color || '—';
      $('v_foto').src              = p.foto || '';
      modalView.showModal();
    }

    function del(id){
      const item = data.find(x=>x.id===id);
      if(!item) return;
      if(confirm(`¿Eliminar "${item.impresora}"?`)){
        data = data.filter(x=>x.id!==id);
        save(data); render();
        toast('Eliminado','error');
      }
    }

    function getFormData(){
      const obj = {};
      for(const k of inputs){
        const el = $(k);
        obj[k] = el.value.trim();
      }
      obj.foto = $('fotoPreview').src || '';
      if(!obj.impresora || !obj.modelo){ toast('Completa IMPRESORA y MODELO','warning'); return null; }
      return obj;
    }

    function savePrinter(){
      const fd = getFormData();
      if(!fd) return;
      if(editingId){
        data = data.map(p => p.id===editingId ? ({...p, ...fd}) : p);
        toast('Actualizado','info');
      }else{
        data.unshift({ id: crypto.randomUUID(), ...fd });
        toast('Guardado','success');
      }
      save(data); render(); modalForm.close();
    }

    // ====== CSV / XLSX (sin foto para mantener tamaño) ======
    function toCSV(list){
      const headers = ['IMPRESORA','MARCA','MODELO','NÚMERO DE SERIE','TONER','COLOR','ÁREA'];
      const keys    = ['impresora','marca','modelo','serie','toner','color','area'];
      const lines = [headers.join(',')].concat(list.map(o => keys.map(k => csvEscape(o[k] ?? '')).join(',')));
      return lines.join('\n');
    }
    function csvEscape(v){ v = String(v); return /[",\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v; }
    function download(filename, blob){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    // Botones desktop
    $('btnExportCSV').addEventListener('click', ()=>{
      const csv = toCSV(data);
      download('IMPRESORAS.csv', new Blob([csv], {type:'text/csv;charset=utf-8;'}));
      toast('CSV exportado','success');
    });
    $('btnExportXLSX').addEventListener('click', ()=>{
      const headers = ['IMPRESORA','MARCA','MODELO','NÚMERO DE SERIE','TONER','COLOR','ÁREA'];
      const rows = data.map(o => ({
        'IMPRESORA': o.impresora ?? '',
        'MARCA': o.marca ?? '',
        'MODELO': o.modelo ?? '',
        'NÚMERO DE SERIE': o.serie ?? '',
        'TONER': o.toner ?? '',
        'COLOR': o.color ?? '',
        'ÁREA': o.area ?? ''
      }));
      const ws = XLSX.utils.json_to_sheet(rows, { header: headers });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'IMPRESORAS');
      const out = XLSX.write(wb, { bookType:'xlsx', type:'array' });
      download('IMPRESORAS.xlsx', new Blob([out], {type: "application/octet-stream"}));
      toast('XLSX exportado','success');
    });
    // Botones móvil (menú)
    $('mCSV')?.addEventListener('click', ()=> $('btnExportCSV').click());
    $('mXLSX')?.addEventListener('click', ()=> $('btnExportXLSX').click());
    $('mImport')?.addEventListener('click', ()=> $('fileImport').click());
    $('mBackup')?.addEventListener('click', ()=> $('btnBackup').click());
    $('mRestore')?.addEventListener('click', ()=> $('btnRestore').click());

    // Import
    document.getElementById('btnImport').addEventListener('click', ()=> $('fileImport').click());
    $('fileImport').addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const name = file.name.toLowerCase();
      if(name.endsWith('.csv')){
        const text = await file.text();
        importRows(parseCSV(text));
      }else if(name.endsWith('.xlsx')){
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type:'array' });
        const sh = wb.SheetNames[0];
        const ws = wb.Sheets[sh];
        const rows = XLSX.utils.sheet_to_json(ws, { defval:'' });
        importRows(rows);
      }else{
        toast('Formato no soportado','error');
      }
      e.target.value = '';
    });

    // Backup / Restore
    $('btnBackup').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json;charset=utf-8;'});
      download(`IMPRESORAS_BACKUP_${new Date().toISOString().slice(0,10)}.json`, blob);
      toast('Respaldo JSON generado','success');
    });
    $('btnRestore').addEventListener('click', ()=> $('fileRestore').click());
    $('fileRestore').addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const arr = JSON.parse(text);
        if(!Array.isArray(arr)) throw new Error('Formato inválido');
        data = arr.map(x => ({
          id: x.id || crypto.randomUUID(),
          impresora: x.impresora || '',
          marca: x.marca || '',
          modelo: x.modelo || '',
          serie: x.serie || '',
          toner: x.toner || '',
          color: x.color || '',
          area: x.area || '',
          foto: x.foto || ''
        }));
        save(data); render();
        toast('Restaurado desde JSON','success');
      }catch(err){
        console.error(err);
        toast('JSON inválido','error');
      } finally {
        e.target.value = '';
      }
    });

    // ====== CSV básico ======
    function parseCSV(str){
      const lines = str.replace(/\r/g,'').split('\n').filter(Boolean);
      if(!lines.length) return [];
      const headers = splitCSVLine(lines[0]).map(h=>h.trim());
      const out = [];
      for(let i=1;i<lines.length;i++){
        const cells = splitCSVLine(lines[i]);
        const obj = {};
        headers.forEach((h,idx)=> obj[h] = cells[idx] ?? '');
        out.push(obj);
      }
      return out;
    }
    function splitCSVLine(line){
      const res = []; let cur = ''; let inQ = false;
      for(let i=0;i<line.length;i++){
        const c = line[i];
        if(c === '"' ){
          if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
          else inQ = !inQ;
        } else if(c === ',' && !inQ){ res.push(cur); cur=''; }
        else cur += c;
      }
      res.push(cur);
      return res;
    }

    // ====== Foto: subir / cámara ======
    const fotoFile     = $('fotoFile');
    const fotoPreview  = $('fotoPreview');
    const camPreview   = $('camPreview');
    const camCanvas    = $('camCanvas');
    const btnShot      = $('btnShot');
    const btnRetake    = $('btnRetake');

    fotoFile?.addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const url = await fileToDataURL(file, 900, 900);
      setPreview(url);
    });

    function setPreview(url){ fotoPreview.src = url || ''; }
    function clearPhoto(){ setPreview(''); if (fotoFile) fotoFile.value=''; }

    function showPhotoTab(which){
      const up = $('paneUpload'), cam = $('paneCamera');
      const tU = $('tabUpload'), tC = $('tabCamera');
      if(which==='upload'){ up.classList.remove('hidden'); cam.classList.add('hidden'); tU.classList.add('tab-active'); tC.classList.remove('tab-active'); }
      else { up.classList.add('hidden'); cam.classList.remove('hidden'); tC.classList.add('tab-active'); tU.classList.remove('tab-active'); }
    }

    async function startCamera(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        camStream = stream;
        camPreview.srcObject = stream;
        camPreview.classList.remove('hidden'); camCanvas.classList.add('hidden');
        btnShot.disabled = false; btnRetake.classList.add('hidden');
      }catch(e){
        toast('No se pudo acceder a la cámara','error');
      }
    }
    function stopCamera(){
      if(camStream){ camStream.getTracks().forEach(t => t.stop()); camStream = null; }
      btnShot.disabled = true; btnRetake.classList.add('hidden');
    }
    function takeShot(){
      if(!camStream) return;
      const track = camStream.getVideoTracks()[0];
      const settings = track.getSettings();
      const w = settings.width || camPreview.videoWidth || 640;
      const h = settings.height|| camPreview.videoHeight|| 480;
      camCanvas.width = w; camCanvas.height = h;
      const ctx = camCanvas.getContext('2d');
      ctx.drawImage(camPreview, 0, 0, w, h);
      const url = camCanvas.toDataURL('image/jpeg', 0.85);
      setPreview(url);
      camPreview.classList.add('hidden'); camCanvas.classList.remove('hidden');
      btnRetake.classList.remove('hidden');
    }
    function retake(){
      camPreview.classList.remove('hidden'); camCanvas.classList.add('hidden');
      setPreview(null);
    }

    function fileToDataURL(file, maxW=900, maxH=900){
      return new Promise((resolve)=>{
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            const { url } = resizeImage(img, maxW, maxH);
            resolve(url);
          };
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
      });
    }
    function resizeImage(img, maxW, maxH){
      let w = img.width, h = img.height;
      const ratio = Math.min(maxW / w, maxH / h, 1);
      const nw = Math.round(w * ratio), nh = Math.round(h * ratio);
      const canvas = document.createElement('canvas');
      canvas.width = nw; canvas.height = nh;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, nw, nh);
      const url = canvas.toDataURL('image/jpeg', 0.85);
      return { url };
    }

    // ====== Búsqueda/Filtros ======
    $('q').addEventListener('input', render);
    $('fColor').addEventListener('change', render);
    $('fArea').addEventListener('change', render);

    // ====== Toast ======
    function toast(msg, type='success'){
      const el = document.createElement('div');
      const styles = { success:'alert-success', error:'alert-error', info:'alert-info', warning:'alert-warning' };
      el.className = `alert ${styles[type]||'alert-info'} shadow`;
      el.innerHTML = `<span>${escapeHTML(msg)}</span>`;
      document.getElementById('toasts').appendChild(el);
      setTimeout(()=> el.remove(), 2500);
    }

    // ====== Partículas ======
    window.addEventListener('DOMContentLoaded', async () => {
      try{
        if (window.tsParticles && document.getElementById('particles')) {
          await window.tsParticles.load({
            id: "particles",
            options: {
              background: { color: "transparent" },
              fpsLimit: 30,
              particles: {
                number: { value: 40, density: { enable: true, area: 800 } },
                color: { value: "#5b6ea8" },
                opacity: { value: 0.2 },
                size: { value: { min: 1, max: 3 } },
                move: { enable: true, speed: 0.6, direction: "none", outModes: { default: "out" } },
                links: { enable: true, distance: 120, opacity: 0.15, width: 1, color: "#5b6ea8" }
              },
              detectRetina: true
            }
          });
        }
      }catch(e){
        console.warn('Particles no cargaron:', e);
      }
    });

    // Init
    render();
  </script>
</body>
</html>

